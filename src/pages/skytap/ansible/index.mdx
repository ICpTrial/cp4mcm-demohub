***

## Ansible Towerの構成

ここでは、**Ansible Tower**を構成していきます。  
IBM Cloud Pak for Multicloud Managementには、**Ansible Engine**によって実行される一連の自動化ジョブを、中央で統合管理するための**Ansible Tower**コンポーネントが統合されています。
これら **Ansible Automation**のテクノロジーを活用することにより、ここでは、運用手順の自動化 **Runbook Automation**を実現していきます。

1. IBM Cloud Pak for Multicloud Managementのメニューから、**Ansible Automation**を開きます。
![image](https://user-images.githubusercontent.com/22209835/114991988-30ddd880-9ed5-11eb-99b5-486f91fe1319.png)
1. `admin` および ブラウザに保管された認証情報でログインします。（または skytapの鍵マークから認証情報を取得してください）。
![image](https://user-images.githubusercontent.com/22209835/114992216-78646480-9ed5-11eb-920b-77f579441148.png)
1. Ansible Towerの ダッシュボードが開きます。この演習では、イベント管理とAnsibleとの連携が主眼ですので、細かい説明は省略します。
![image](https://user-images.githubusercontent.com/22209835/114992391-a9dd3000-9ed5-11eb-8f47-9188671b77d0.png)
1. まず、Ansible ジョブ実行対象に対する認証情報を定義します。左のメニューから **Credentials**を選んで、緑色の `+`ボタンをクリックして、新しい認証情報を定義します。 
![image](https://user-images.githubusercontent.com/22209835/114992676-fc1e5100-9ed5-11eb-8f6a-54fd59b5cdcd.png)
1. ここでは ２種類の認証情報を定義します。  
　１つはvCenterの認証情報を定義です。これを使って、Ansible Towerは定義されたVMWare vSphereから環境の情報を取得します。  
　もう一つは、個々の仮想マシンにSSHでアクセスして、Ansible Playbookを実行するための認証情報です。ubuntuの仮想マシン用と、desktopVM用の２つ定義します。
   1. vSphereの認証情報を定義し、保管します。
        |名前|設定値|備考|
        --|--|--
        |Name|vcenter||
        |Cderential Type|VMware vCenter|検索ボックスから選択|
        |vCenterHost|10.0.0.100||
        |Username|administrator@vsphere.local||
        |Password|P@ssw0rd||
        
        ![image](https://user-images.githubusercontent.com/22209835/114993562-e3fb0180-9ed6-11eb-9b7e-5674d5f89b66.png)

   1. `vcenter`が追加されたことを確認し、もう一度 `+`をクリックします。
        ![image](https://user-images.githubusercontent.com/22209835/114994474-c4180d80-9ed7-11eb-8e09-4bd232a930ac.png)

   1. 仮想マシン ubuntu の認証情報を定義し、保管します。
        |名前|設定値|備考|
        --|--|--
        |Name|ubuntu||
        |Cderential Type|Machine|検索ボックスから選択|
        |Username|ibmuser||
        |Password|passw0rd||
        |SSH PRIVATE KEY||この演習では利用しませんが、SSHキーでログインするよう定義も可能です|

        ![image](https://user-images.githubusercontent.com/22209835/114994895-3b4da180-9ed8-11eb-88e9-ffc9906ec6f3.png)

   1. 仮想マシン desktop の認証情報を定義し、保管します。
        |名前|設定値|備考|
        --|--|--
        |Name|desktop||
        |Cderential Type|Machine|検索ボックスから選択|
        |Username|ibmuser||
        |Password|engageibm||

        ![image](https://user-images.githubusercontent.com/22209835/114995290-a1d2bf80-9ed8-11eb-9073-c0d526449512.png)

   1. ubuntu および desktopの認証情報が追加されたことを確認します。
        ![image](https://user-images.githubusercontent.com/22209835/114995619-fd04b200-9ed8-11eb-8734-6718f4c2eecf.png)

1. 次に インベントリー（ジョブを実行する管理対象となるサーバー）を定義していきましょう。メニューから**Inventories**をクリックします。
![image](https://user-images.githubusercontent.com/22209835/115168567-60b7f680-a0f6-11eb-8537-44054738b94b.png)

   1. インベントリーは、個別に情報を追加する 静的インベントリーと、認証情報を追加することにより パブリック・クラウドおよびプライベート・クラウドで稼働する仮想マシンを自動的に構成する動的インベントリーがあります。ここでは、動的インベントリーを構成します。右上の緑色の`+`ボタンをクリックし、**Inventory**をクリックします。
    ![image](https://user-images.githubusercontent.com/22209835/115168832-2ef35f80-a0f7-11eb-8fee-5f7cff097623.png)
   1. 名前に `vmware`と入力して保管します。
    ![image](https://user-images.githubusercontent.com/22209835/115168849-42062f80-a0f7-11eb-9f54-95250d14777a.png)
   1. **Sources**タブを開き、緑色の`+`ボタンをクリックします。
    ![image](https://user-images.githubusercontent.com/22209835/115168952-a3c69980-a0f7-11eb-9387-16811d5ad2d7.png)
   1. **Create Source**画面で、名前として `vCenter`を入力し、Sourceとして、`VMware vCenter`を指定します。
    ![image](https://user-images.githubusercontent.com/22209835/115169615-8397da00-a0f9-11eb-853d-4b65231b6c21.png)
   1. vcenterの認証情報は一つしか定義されていないので、 `vcenter`が自動的に選ばれているはずです。別途定義を作成して、複数認証情報がある場合は明示的に指定してください。
    ![image](https://user-images.githubusercontent.com/22209835/115169667-a32f0280-a0f9-11eb-84df-ec8f10670348.png)
   1. **Sources**タブに戻り、右端から二つ目の **Sync**アイコン（矢印が回転しているマーク）を クリックして、VMWare 環境から情報を取得します。
    ![image](https://user-images.githubusercontent.com/22209835/115169778-f608ba00-a0f9-11eb-95a2-6b33977cf287.png)
   1. **Sync**が正しくできた場合には、**Inventory**下の `vmware` の雲アイコンが緑色になります。`vmware`のリンクをクリックします。
    ![image](https://user-images.githubusercontent.com/22209835/115169863-3405de00-a0fa-11eb-8198-c09557bbec26.png)
   1. `vmware`の画面で**HOSTS**タブを開き、インポートされたサーバーを確認します。
    ![image](https://user-images.githubusercontent.com/22209835/115169967-75968900-a0fa-11eb-9445-e48011e61a5d.png)
   1. その他のホストを静的インベントリーに追加します。再び**Inventory**をメニューから選び、緑色の`+`ボタンをクリックします。
    ![image](https://user-images.githubusercontent.com/22209835/115170198-0705fb00-a0fb-11eb-870d-24f1fde9e25d.png)
   1. インベントリ名に `static`と指定して、**Save**をクリックします。
    ![image](https://user-images.githubusercontent.com/22209835/115170416-8eec0500-a0fb-11eb-9745-7400eb70f697.png)
   1. **HOSTS**タブを選び、緑色の`+`ボタンをクリックし、**Host name**に `10.0.0.10`を指定、**Save**をクリックします。このサーバーは、もろもろの 操作を実施している desktopサーバーです。
    ![image](https://user-images.githubusercontent.com/22209835/115170647-0cb01080-a0fc-11eb-8f32-7014a4dd9c22.png)
   ここまでで、Inventoryの構成は終わりです。
   
***

## Ansible Plaubookの登録
Ansible は、非常に人気のある自動化ツールです。Playbookと呼ばれる多様な自動化スクリプトが、コミュニティで開発されています。Ansibleの基礎自体は、この演習では扱いませんが、ここでは 事前定義されたサンプルのplaybooを利用して作業を実施します。Ansibleについて詳しく学びたい場合は、[Ansible website](https://www.ansible.com) を見てみて下さい。

ここでのサンプル・アプリケーションは、イベントが発生した際にターゲットに対して、アクションとして実行されれるものです。ここでは、アプリケーションの再起動を実施します。

1. Ansible Playbookを配置するプロジェクトを作成します。
    1. メニューから**Projects**を選択し、緑色の`+`ボタンをクリックします。
    ![image](https://user-images.githubusercontent.com/22209835/115171548-336f4680-a0fe-11eb-88fd-47bbc3483661.png)
    1. プロジェクト名として**runbook-automation** を指定して、SCM(Source Code Management)タイプとして、**Git**を指定し、SCM URLとして **https://github.com/dymaczew/rba-ansible-sample** を入力します。**Save**をクリックして設定を保管します。
    ![image](https://user-images.githubusercontent.com/22209835/115171780-cc05c680-a0fe-11eb-80ff-1887107bed16.png)
    1. 定義を作成すると、登録されたSCM(今回はGitHub)と同期を取ります。正常に同期されると、左端のボタンが グルーンになります。
    ![image](https://user-images.githubusercontent.com/22209835/115171876-02dbdc80-a0ff-11eb-9c5e-f4a5dd6c7053.png)
1. 登録したPlaybookを利用して、実際に実行する**Job templates**を作成します。
    1. プロジェクト **runbook-automation** で、**JOB TEMPLATES**のタブを開いて、緑の`+`ボタンをクリックして、以下の定義を入力して、**Save**します。
        |項目名|値|備考|
        --|--|--
        |名前|Start_Online_Banking||
        |Inventory|static|ジョブテンプレートの実行先|
        |Porject|runbook-automation||
        |Credential|desktop|認証情報|
        |Verbosity|0 (Normal)|ジョブのログのメッセージレベル|
        |Playbook|start-online-banking.yaml|Gitから取得されたPlaybook本体|
    ![image](https://user-images.githubusercontent.com/22209835/115172911-23a53180-a101-11eb-97f1-a75f30a1ab1b.png)
 これで Ansibleの準備は終了です。
